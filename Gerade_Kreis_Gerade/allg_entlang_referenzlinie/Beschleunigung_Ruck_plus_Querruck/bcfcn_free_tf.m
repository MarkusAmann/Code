function res = bcfcn_free_tf(XL,XR,param,p)
nu_tilde_t1 = param(1);
nu_tilde_t2 = param(2);
delta_t1 = param(3);
delta_t2 = param(4);
delta_t3 = param(5);

X0 = XL(:,1);
Xf = XR(:,end);
X_internal_L_1 = [XL(1:6,2); XR(7:12,1)];
X_internal_L_2 = [XL(1:6,end); XR(7:12,2)];
X_internal_R_1 = [XR(1:6,1); XL(7:12,2)];
X_internal_R_2 = [XR(1:6,2); XL(7:12,end)];

% Endzustand
srf = Xf(1);
vf = Xf(2);
af = Xf(3);
drf = Xf(4);
psirf = Xf(5);
kappaf = Xf(6);
l1f = Xf(7);
l2f = Xf(8);
l3f = Xf(9);
l4f = Xf(10);
l5f = Xf(11);
l6f = Xf(12);

% Stellgrößen tf, Kurve
uf = uopt(Xf,p);
jf = uf(1);
dkappaf = uf(2);

%% interner RB t1
% linker Randzustand von t1
sL_1 = X_internal_L_1(1);
vL_1 = X_internal_L_1(2);
aL_1 = X_internal_L_1(3);
drL_1 = X_internal_L_1(4);
psirL_1 = X_internal_L_1(5);
kappaL_1 = X_internal_L_1(6);
l1L_1 = X_internal_L_1(7);
l2L_1 = X_internal_L_1(8);
l3L_1 = X_internal_L_1(9);
l4L_1 = X_internal_L_1(10);
l5L_1 = X_internal_L_1(11);
l6L_1 = X_internal_L_1(12);

% rechter Randzustand von t1
sR_1 = X_internal_R_1(1);
vR_1 = X_internal_R_1(2);
aR_1 = X_internal_R_1(3);
drR_1 = X_internal_R_1(4);
psirR_1 = X_internal_R_1(5);
kappaR_1 = X_internal_R_1(6);
l1R_1 = X_internal_R_1(7);
l2R_1 = X_internal_R_1(8);
l3R_1 = X_internal_R_1(9);
l4R_1 = X_internal_R_1(10);
l5R_1 = X_internal_R_1(11);
l6R_1 = X_internal_R_1(12);

% Stellgrößen linker und rechter Rand von t1
uL_1 = uopt(X_internal_L_1,p);
jL_1 = uL_1(1);
dkappaL_1 = uL_1(2); 

uR_1 = uopt(X_internal_R_1,p);
jR_1 = uR_1(1);
dkappaR_1 = uR_1(2); 

%% interner RB t2
% linker Randzustand von t2
sL_2 = X_internal_L_2(1);
vL_2 = X_internal_L_2(2);
aL_2 = X_internal_L_2(3);
drL_2 = X_internal_L_2(4);
psirL_2 = X_internal_L_2(5);
kappaL_2 = X_internal_L_2(6);
l1L_2 = X_internal_L_2(7);
l2L_2 = X_internal_L_2(8);
l3L_2 = X_internal_L_2(9);
l4L_2 = X_internal_L_2(10);
l5L_2 = X_internal_L_2(11);
l6L_2 = X_internal_L_2(12);


% rechter Randzustand von t1
sR_2 = X_internal_R_2(1);
vR_2 = X_internal_R_2(2);
aR_2 = X_internal_R_2(3);
drR_2 = X_internal_R_2(4);
psirR_2 = X_internal_R_2(5);
kappaR_2 = X_internal_R_2(6);
l1R_2 = X_internal_R_2(7);
l2R_2 = X_internal_R_2(8);
l3R_2 = X_internal_R_2(9);
l4R_2 = X_internal_R_2(10);
l5R_2 = X_internal_R_2(11);
l6R_2 = X_internal_R_2(12);

% Stellgrößen linker und rechter Rand von t1
uL_2 = uopt(X_internal_L_2,p);
jL_2 = uL_2(1);
dkappaL_2 = uL_2(2); 

uR_2 = uopt(X_internal_R_2,p);
jR_2 = uR_2(1);
dkappaR_2 = uR_2(2); 


jyf = dkappaf*vf^2 + 2*kappaf*af*vf;
jyL_1 = dkappaL_1*vL_1^2 + 2*kappaL_1*aL_1*vL_1;
jyR_1 = dkappaR_1*vR_1^2 + 2*kappaR_1*aR_1*vR_1;
jyL_2 = dkappaL_2*vL_2^2 + 2*kappaL_2*aL_2*vL_2;
jyR_2 = dkappaR_2*vR_2^2 + 2*kappaR_2*aR_2*vR_2;

switch p.use_dr
    case 1
        % H(tf)+1=0 mit Zustandsbestrafung im Gütefunktional
        H_tf = 1/2*p.fr*drf^2 + 1/2*p.fjx*jf^2 + 1/2*p.fax*af^2 + 1/2*p.fjy*jyf^2 + 1/2*p.fay*kappaf^2*vf^4 + ...
            l1f*vf*cos(psirf)/(1-drf*p.kapparef_straight) + l2f*af + l3f*jf + l4f*vf*sin(psirf) + l5f*vf*(kappaf - p.kapparef_straight*cos(psirf)/(1-drf*p.kapparef_straight)) + l6f*dkappaf;
        
        H_L_1 = 1/2*p.fr*drL_1^2 + 1/2*p.fjx*jL_1^2 + 1/2*p.fax*aL_1^2 + 1/2*p.fjy*jyL_1^2 + 1/2*p.fay*kappaL_1^2*vL_1^4 + ...
            l1L_1*vL_1*cos(psirL_1)/(1-drL_1*p.kapparef_straight) + l2L_1*aL_1 + l3L_1*jL_1 + l4L_1*vL_1*sin(psirL_1) + l5L_1*vL_1*(kappaL_1 - p.kapparef_straight*cos(psirL_1)/(1-drL_1*p.kapparef_straight)) + l6L_1*dkappaL_1;
        
        H_R_1 = 1/2*p.fr*drR_1^2 + 1/2*p.fjx*jR_1^2 + 1/2*p.fax*aR_1^2 + 1/2*p.fjy*jyR_1^2 + 1/2*p.fay*kappaR_1^2*vR_1^4 + ...
            l1R_1*vR_1*cos(psirR_1)/(1-drR_1*p.kapparef_curve) + l2R_1*aR_1 + l3R_1*jR_1 + l4R_1*vR_1*sin(psirR_1) + l5R_1*vR_1*(kappaR_1 - p.kapparef_curve*cos(psirR_1)/(1-drR_1*p.kapparef_curve)) + l6R_1*dkappaR_1;
        
        H_L_2 = 1/2*p.fr*drL_2^2 + 1/2*p.fjx*jL_2^2 + 1/2*p.fax*aL_2^2 + 1/2*p.fjy*jyL_2^2 + 1/2*p.fay*kappaL_2^2*vL_2^4 + ...
            l1L_2*vL_2*cos(psirL_2)/(1-drL_2*p.kapparef_curve) + l2L_2*aL_2 + l3L_2*jL_2 + l4L_2*vL_2*sin(psirL_2) + l5L_2*vL_2*(kappaL_2 - p.kapparef_curve*cos(psirL_2)/(1-drL_2*p.kapparef_curve)) + l6L_2*dkappaL_2;
        
        H_R_2 = 1/2*p.fr*drR_2^2 + 1/2*p.fjx*jR_2^2 + 1/2*p.fax*aR_2^2 + 1/2*p.fjy*jyR_2^2 + 1/2*p.fay*kappaR_2^2*vR_2^4 + ...
            l1R_2*vR_2*cos(psirR_2)/(1-drR_2*p.kapparef_straight) + l2R_2*aR_2 + l3R_2*jR_2 + l4R_2*vR_2*sin(psirR_2) + l5R_2*vR_2*(kappaR_2 - p.kapparef_straight*cos(psirR_2)/(1-drR_2*p.kapparef_straight)) + l6R_2*dkappaR_2;
        
   case 0
        % H(tf)+1=0 ohne Zustandsbestrafung im Gütefunktional
        H_tf = 1/2*p.fjx*jf^2 + 1/2*p.fax*af^2 + 1/2*p.fjy*jyf^2 + 1/2*p.fay*kappaf^2*vf^4 + ...
            l1f*vf*cos(psirf)/(1-drf*p.kapparef_straight) + l2f*af + l3f*jf + l4f*vf*sin(psirf) + l5f*vf*(kappaf - p.kapparef_straight*cos(psirf)/(1-drf*p.kapparef_straight)) + l6f*dkappaf;
        
        H_L_1 = 1/2*p.fjx*jL_1^2 + 1/2*p.fax*aL_1^2 + 1/2*p.fjy*jyL_1^2 + 1/2*p.fay*kappaL_1^2*vL_1^4 + ...
            l1L_1*vL_1*cos(psirL_1)/(1-drL_1*p.kapparef_straight) + l2L_1*aL_1 + l3L_1*jL_1 + l4L_1*vL_1*sin(psirL_1) + l5L_1*vL_1*(kappaL_1 - p.kapparef_straight*cos(psirL_1)/(1-drL_1*p.kapparef_straight)) + l6L_1*dkappaL_1;
        
        H_R_1 = 1/2*p.fjx*jR_1^2 + 1/2*p.fax*aR_1^2 + 1/2*p.fjy*jyR_1^2 + 1/2*p.fay*kappaR_1^2*vR_1^4 + ...
            l1R_1*vR_1*cos(psirR_1)/(1-drR_1*p.kapparef_curve) + l2R_1*aR_1 + l3R_1*jR_1 + l4R_1*vR_1*sin(psirR_1) + l5R_1*vR_1*(kappaR_1 - p.kapparef_curve*cos(psirR_1)/(1-drR_1*p.kapparef_curve)) + l6R_1*dkappaR_1;
        
        H_L_2 = 1/2*p.fjx*jL_2^2 + 1/2*p.fax*aL_2^2 + 1/2*p.fjy*jyL_2^2 + 1/2*p.fay*kappaL_2^2*vL_2^4 + ...
            l1L_2*vL_2*cos(psirL_2)/(1-drL_2*p.kapparef_curve) + l2L_2*aL_2 + l3L_2*jL_2 + l4L_2*vL_2*sin(psirL_2) + l5L_2*vL_2*(kappaL_2 - p.kapparef_curve*cos(psirL_2)/(1-drL_2*p.kapparef_curve)) + l6L_2*dkappaL_2;
        
        H_R_2 = 1/2*p.fjx*jR_2^2 + 1/2*p.fax*aR_2^2 + 1/2*p.fjy*jyR_2^2 + 1/2*p.fay*kappaR_2^2*vR_2^4 + ...
            l1R_2*vR_2*cos(psirR_2)/(1-drR_2*p.kapparef_straight) + l2R_2*aR_2 + l3R_2*jR_2 + l4R_2*vR_2*sin(psirR_2) + l5R_2*vR_2*(kappaR_2 - p.kapparef_straight*cos(psirR_2)/(1-drR_2*p.kapparef_straight)) + l6R_2*dkappaR_2;
 end

% sf, psirf sind festgelegt, vf, af, drf, kappaf sind frei
% res = [X0(1) - p.x0(1);...
%     X0(2) - p.x0(2);...
%     X0(3) - p.x0(3);...
%     X0(4) - p.x0(4);...
%     X0(5) - p.x0(5);...
%     X0(6) - p.x0(6);...
%     srf - p.sf;...
%     psirf - p.psirf;...
%     l2f;...
%     l3f;
%     l4f;...
%     l6f;...
%     H_tf + 1;...
%     sL_1 - sR_1;... % Stetigkeit am internen Randwert
%     vL_1 - vR_1;...
%     drL_1 - drR_1;...
%     aL_1 - aR_1;...
%     psirL_1 - psirR_1;...
%     kappaL_1 - kappaR_1;...
%     l1L_1 - l1R_1 - 2*nu_tilde_t1;... % Transversalitätsbedingung für l1 (l1(t1-) = l1(t1+) + dg/dx|t1*nu_tilde)
%     l2L_1 - l2R_1;...
%     l3L_1 - l3R_1;...
%     l4L_1 - l4R_1;...
%     l5L_1 - l5R_1;...
%     l6L_1 - l6R_1;...
%     sL_1 - p.s1;... % zusätzliche interne Randbedingung
%     H_L_1 - H_R_1 + 0;... % Transversalitätsbedingung für Umschaltpunkt
%     sL_2 - sR_2;... % Stetigkeit am internen Randwert
%     vL_2 - vR_2;...
%     drL_2 - drR_2;...
%     aL_2 - aR_2;...
%     psirL_2 - psirR_2;...
%     kappaL_2 - kappaR_2;...
%     l1L_2 - l1R_2 - 2*nu_tilde_t2;... % Transversalitätsbedingung für l1 (l1(t1-) = l1(t1+) + dg/dx|t1*nu_tilde)
%     l2L_2 - l2R_2;...
%     l3L_2 - l3R_2;...
%     l4L_2 - l4R_2;...
%     l5L_2 - l5R_2;...
%     l6L_2 - l6R_2;...
%     sL_2 - p.s1;... % zusätzliche interne Randbedingung
%     H_L_2 - H_R_2 + 0]; % Transversalitätsbedingung für Umschaltpunkt

% sf, drf, psirf sind festgelegt, vf, af, kappaf sind frei
res = [X0(1) - p.x0(1);...
    X0(2) - p.x0(2);...
    X0(3) - p.x0(3);...
    X0(4) - p.x0(4);...
    X0(5) - p.x0(5);...
    X0(6) - p.x0(6);...
    srf - p.sf;...
    drf - p.drf;...
    psirf - p.psirf;...
    l2f;...
    l3f;
    l6f;...
    H_tf + 1;...
    sL_1 - sR_1;... % Stetigkeit am internen Randwert
    vL_1 - vR_1;...
    drL_1 - drR_1;...
    aL_1 - aR_1;...
    psirL_1 - psirR_1;...
    kappaL_1 - kappaR_1;...
    l1L_1 - l1R_1 - 2*nu_tilde_t1;... % Transversalitätsbedingung für l1 (l1(t1-) = l1(t1+) + dg/dx|t1*nu_tilde)
    l2L_1 - l2R_1;...
    l3L_1 - l3R_1;...
    l4L_1 - l4R_1;...
    l5L_1 - l5R_1;...
    l6L_1 - l6R_1;...
    sL_1 - p.s1;... % zusätzliche interne Randbedingung
    H_L_1 - H_R_1 + 0;... % Transversalitätsbedingung für Umschaltpunkt
    sL_2 - sR_2;... % Stetigkeit am internen Randwert
    vL_2 - vR_2;...
    drL_2 - drR_2;...
    aL_2 - aR_2;...
    psirL_2 - psirR_2;...
    kappaL_2 - kappaR_2;...
    l1L_2 - l1R_2 - 2*nu_tilde_t2;... % Transversalitätsbedingung für l1 (l1(t1-) = l1(t1+) + dg/dx|t1*nu_tilde)
    l2L_2 - l2R_2;...
    l3L_2 - l3R_2;...
    l4L_2 - l4R_2;...
    l5L_2 - l5R_2;...
    l6L_2 - l6R_2;...
    sL_2 - p.s2;... % zusätzliche interne Randbedingung
    H_L_2 - H_R_2 + 0]; % Transversalitätsbedingung für Umschaltpunkt

end
